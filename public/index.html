<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macave Mining - Dashboard Final</title>
<style>
body { font-family: Arial; background:#f4f7fa; margin:0; color:#333; display:flex; justify-content:center; align-items:flex-start; padding-top:20px; }
.container { background:white; padding:30px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1); width:400px; text-align:center; }
h2 { color:#0074D9; }
h3 { margin-top:20px; }
input { width:100%; padding:10px; margin:10px 0; border-radius:5px; border:1px solid #ccc; }
button { width:100%; padding:10px; border:none; border-radius:5px; background:#0074D9; color:white; cursor:pointer; margin:5px 0; }
button:hover { background:#005fa3; }
.message { margin:10px 0; color:green; }
.error { color:red; }
#dashboard { display:none; }
.plan { border:1px solid #ccc; padding:10px; margin:5px; border-radius:5px; text-align:left; }
.withdraw-history { text-align:left; margin-top:10px; font-size:14px; }
</style>
</head>
<body>

<!-- Autentica칞칚o -->
<div class="container" id="auth">
  <h2>Macave Mining</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Senha">
  <button onclick="register()">Registrar</button>
  <button onclick="login()">Login</button>
  <div class="message" id="message"></div>
</div>

<!-- Dashboard -->
<div class="container" id="dashboard">
  <h2>Bem-vindo!</h2>
  <p>Saldo: <span id="balance">0</span> 游눑</p>

  <!-- Planos -->
  <h3>Planos Dispon칤veis</h3>
  <div id="plans"></div>

  <!-- Planos Comprados -->
  <h3>Planos Ativos</h3>
  <div id="activePlans">Nenhum plano comprado ainda.</div>

  <!-- Saque -->
  <h3>Saque</h3>
  <input type="number" id="withdrawAmount" placeholder="Valor do saque">
  <button onclick="requestWithdraw()">Solicitar Saque</button>

  <!-- Hist칩rico de Saques -->
  <h3>Hist칩rico de Saques</h3>
  <div class="withdraw-history" id="withdrawHistory">Nenhum saque ainda.</div>

  <button onclick="logout()">Logout</button>
  <div class="message" id="dashMessage"></div>
</div>

<script>
const API_URL = "https://macave-mining.onrender.com/api";
let token = null;
let balance = 100; // saldo inicial simulado
let withdraws = [];
let activePlans = [];

// Mensagens
function showMessage(text, isError=false) {
  const msg = document.getElementById("message");
  msg.textContent = text;
  msg.className = isError ? "error" : "message";
}

function showDashMessage(text, isError=false) {
  const msg = document.getElementById("dashMessage");
  msg.textContent = text;
  msg.className = isError ? "error" : "message";
}

// Atualiza saldo
function updateBalanceDisplay() {
  document.getElementById("balance").textContent = balance.toFixed(2);
}

// Atualiza hist칩rico de saques
function updateWithdrawHistory() {
  const histDiv = document.getElementById("withdrawHistory");
  if(withdraws.length === 0) histDiv.textContent = "Nenhum saque ainda.";
  else histDiv.innerHTML = withdraws.map(w => `${w.amount} 游눑 - ${w.date}`).join("<br>");
}

// Atualiza planos ativos
function renderActivePlans() {
  const activeDiv = document.getElementById("activePlans");
  if(activePlans.length === 0) {
    activeDiv.textContent = "Nenhum plano comprado ainda.";
  } else {
    activeDiv.innerHTML = activePlans.map(p => `${p.name} - Lucro por 5s: ${p.profit} 游눑`).join("<br>");
  }
}

// ---------------- Registro ----------------
async function register() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const res = await fetch(`${API_URL}/auth/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if(res.ok) showMessage(data.message);
    else showMessage(data.error, true);
  } catch(err) {
    showMessage("Erro de conex칚o", true);
  }
}

// ---------------- Login ----------------
async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const res = await fetch(`${API_URL}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if(res.ok) {
      token = data.token;
      document.getElementById("auth").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      updateBalanceDisplay();
      renderPlans();
      renderActivePlans();
      updateWithdrawHistory();
      showDashMessage("Login bem-sucedido!");
      startProfitSimulation();
    } else {
      showMessage(data.error, true);
    }
  } catch(err) {
    showMessage("Erro de conex칚o", true);
  }
}

// ---------------- Logout ----------------
function logout() {
  token = null;
  document.getElementById("auth").style.display = "block";
  document.getElementById("dashboard").style.display = "none";
  showMessage("");
  showDashMessage("");
}

// ---------------- Planos ----------------
const plans = [
  { id: 1, name: "Bronze", price: 10, profit: 1 },
  { id: 2, name: "Prata", price: 50, profit: 6 },
  { id: 3, name: "Ouro", price: 100, profit: 15 },
];

function renderPlans() {
  const plansDiv = document.getElementById("plans");
  plansDiv.innerHTML = "";
  plans.forEach(plan => {
    const div = document.createElement("div");
    div.className = "plan";
    div.innerHTML = `
      <strong>${plan.name}</strong><br>
      Pre칞o: $${plan.price} 游눑<br>
      Lucro: $${plan.profit} 游눑 / 5s<br>
      <button onclick="buyPlan(${plan.id})">Comprar</button>
    `;
    plansDiv.appendChild(div);
  });
}

function buyPlan(planId) {
  const plan = plans.find(p => p.id === planId);
  if(!plan) return;
  if(balance < plan.price) return showDashMessage("Saldo insuficiente", true);
  balance -= plan.price;
  activePlans.push({...plan});
  updateBalanceDisplay();
  renderActivePlans();
  showDashMessage(`Voc칡 comprou o plano ${plan.name}!`);
}

// ---------------- Saque Simulado ----------------
async function requestWithdraw() {
  const amount = parseFloat(document.getElementById("withdrawAmount").value);
  if(!amount || amount <= 0) return showDashMessage("Valor inv치lido", true);
  if(amount > balance) return showDashMessage("Saldo insuficiente", true);

  try {
    const res = await fetch(`${API_URL}/withdraw/request`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": token
      },
      body: JSON.stringify({ amount, method:"simulado", destination:"teste" })
    });
    const data = await res.json();
    if(res.ok || data.message) {
      balance -= amount;
      withdraws.push({ amount, date: new Date().toLocaleString() });
      updateBalanceDisplay();
      updateWithdrawHistory();
      showDashMessage("Saque solicitado com sucesso!");
    } else {
      showDashMessage(data.error || "Erro no saque", true);
    }
  } catch(err) {
    showDashMessage("Erro de conex칚o", true);
  }
}

// ---------------- Lucro Autom치tico por Plano ----------------
function startProfitSimulation() {
  setInterval(() => {
    let totalProfit = 0;
    activePlans.forEach(plan => {
      totalProfit += plan.profit;
    });
    balance += totalProfit;
    updateBalanceDisplay();
  }, 5000); // a cada 5 segundos
}

</script>

</body>
</html>
